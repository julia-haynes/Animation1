<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Moon Crater Time Animation</title>

  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    body {
      background: #111;
      color: white;
      font-family: sans-serif;
      text-align: center;
    }
    #sliderContainer { margin-top: 20px; }
    input[type="range"] { width: 80%; }

    button {
      padding: 10px 20px;
      background: #444;
      color: white;
      border: none;
      font-size: 16px;
      cursor: pointer;
      border-radius: 6px;
    }
  </style>
</head>

<body>
<h2>Moon Crater Evolution (TimeStep)</h2>

<button id="playBtn">▶ Play</button>

<div id="sliderContainer">
  <input id="timeSlider" type="range" min="0" max="100" value="0" step="1">
  <div>Current timestep: <span id="timeValue">0</span></div>
</div>

<svg id="svg" width="800" height="800"></svg>

<script>
const width = 800, height = 800;
const svg = d3.select("#svg");

// Projection
let projection = d3.geoOrthographic()
  .scale(350)
  .translate([width/2, height/2])
  .clipAngle(90)
  .rotate([-31.4, -8.5]);

const path = d3.geoPath().projection(projection);

// Draw sphere
svg.append("path")
  .datum({ type: "Sphere" })
  .attr("fill", "#222")
  .attr("stroke", "#888")
  .attr("d", path);

// Drag to rotate
svg.call(
  d3.drag()
    .on("drag", (event) => {
      const rot = projection.rotate();
      projection.rotate([rot[0] + event.dx * 0.25, rot[1] - event.dy * 0.25]);
      svg.select("path").attr("d", path);
      update(currentTimestep);
    })
);

// Load data
d3.json("tranq.json").then(data => {

  data.forEach(d => {
    d.Longitude = +d.Longitude;
    d.Latitude  = +d.Latitude;
    d.Size  = +d.Size;
    d.TimeStep = +d.TimeStep;
  });

  const minT = d3.min(data, d => d.TimeStep);
  const maxT = d3.max(data, d => d.TimeStep);

  const slider = document.getElementById("timeSlider");
  slider.min = minT;
  slider.max = maxT;

  const radiusScale = d3.scaleSqrt()
    .domain([0.5, 600])
    .range([1, 40]);

  let currentTimestep = minT;

  // --- Compute animation duration FIRST ---
  const totalSteps = Math.max(1, maxT - minT);  // avoid divide-by-zero
  const totalDurationMs = 20 * 1000;            // 30 seconds
  const stepDuration = totalDurationMs / totalSteps;

  // --- Update function (FIXED) ---
  function update(t) {
    const filtered = data.filter(d => d.TimeStep <= t);

    const circles = svg.selectAll("circle.survived")
      .data(filtered, d => d.Longitude + "_" + d.Latitude);

    circles.exit()
      .transition().duration(stepDuration * 0.7)
      .attr("r", 0)
      .remove();

    circles.enter()
      .append("circle")
      .attr("class", "survived")
      .attr("fill", "white")
      .attr("stroke", "black")
      .attr("stroke-width", 0.5)
      .attr("opacity", 0.9)
      .attr("r", 0)
      .attr("cx", d => projection([d.Longitude, d.Latitude])[0])
      .attr("cy", d => projection([d.Longitude, d.Latitude])[1])
      .merge(circles)
      .transition().duration(stepDuration)
      .attr("r", d => radiusScale(d.Size / 2))
      .attr("cx", d => projection([d.Longitude, d.Latitude])[0])
      .attr("cy", d => projection([d.Longitude, d.Latitude])[1]);
  }

  // Initial render
  update(minT);
  slider.value = minT;
  document.getElementById("timeValue").textContent = minT;

  // Slider control
  slider.addEventListener("input", () => {
    currentTimestep = +slider.value;
    document.getElementById("timeValue").textContent = currentTimestep;
    update(currentTimestep);
  });

  // --- Play button ---
  let playing = false;
  let timer = null;

  document.getElementById("playBtn").addEventListener("click", () => {
    if (!playing) {
      playing = true;
      document.getElementById("playBtn").textContent = "⏸ Pause";

      timer = setInterval(() => {
        currentTimestep++;

        if (currentTimestep > maxT) {
          clearInterval(timer);
          playing = false;
          document.getElementById("playBtn").textContent = "▶ Play";
          return;
        }

        slider.value = currentTimestep;
        document.getElementById("timeValue").textContent = currentTimestep;
        update(currentTimestep);

      }, stepDuration);

    } else {
      playing = false;
      document.getElementById("playBtn").textContent = "▶ Play";
      clearInterval(timer);
    }
  });

});
</script>

<div id="mareButtons">
  <button onclick="location.href='entire_moon.html'">Click here to view the entire moon</button>
  <button onclick="location.href='imbrium.html'">Click here to view Mare Imbrium</button>
  <button onclick="location.href='oceanus.html'">Click here to view Oceanus Serenetatis</button>
</div>

</body>
</html>